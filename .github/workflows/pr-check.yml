name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================================================
  # PR Code Quality
  # ============================================================================
  pr-quality:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper diff
        
    - name: ğŸ”§ Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy
        
    - name: ğŸ¨ Check formatting
      run: |
        echo "Checking code formatting..."
        ./scripts/format.sh
        
    - name: ğŸ“Š Generate PR comment
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âš ï¸ **Code formatting issues detected**\n\nPlease format your code:\n```bash\n./scripts/format.sh --format\n```'
          })
          
  # ============================================================================
  # PR Build Test
  # ============================================================================
  pr-build:
    name: PR Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Conan
      run: |
        pip install conan
        conan profile detect --force
        
    - name: ğŸ”§ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake g++ \
          libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
          libudev-dev libgl1-mesa-dev libopenal-dev \
          libflac-dev libvorbis-dev
          
    - name: ğŸ“¦ Conan install
      run: |
        conan install . --output-folder=build --build=missing -s build_type=Release
        
    - name: âš™ï¸ Configure
      run: |
        cmake --preset conan-release
        
    - name: ğŸ”¨ Build
      run: |
        cmake --build build/build/Release --config Release -j $(nproc)
        
    - name: ğŸ§ª Test
      run: |
        cd build/build/Release
        ctest --output-on-failure -C Release
        
    - name: âœ… PR Success Comment
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **All checks passed!**\n\n- âœ… Code compiles\n- âœ… All tests pass\n- âœ… Formatting is correct\n\nReady for review! ğŸš€'
          })
